<table class="MoyTable" mat-table multiTemplateDataRows [dataSource]="config.matrix$">
  <!-- Column Defs -->
  <ng-container [matColumnDef]="column" *ngFor="let column of config.columns; trackBy: columnFn">
    <th mat-header-cell *matHeaderCellDef>{{ config.customColumnText[column] || column | titlecase }}</th>

    <td mat-cell *matCellDef="let row">
      <ng-container [ngSwitch]="row.type">
        <ng-container *ngSwitchCase="RowType.Expandable">
          <ng-container *ngTemplateOutlet="expandableCell; context: { row: row, column: column }"></ng-container>
        </ng-container>

        <ng-container *ngSwitchDefault>
          <ng-container *ngTemplateOutlet="defaultCell; context: { row: row, column: column }"></ng-container>
        </ng-container>
      </ng-container>
    </td>
  </ng-container>

  <ng-container matColumnDef="__rowContent__">
    <td mat-cell *matCellDef="let innerRow" [attr.colspan]="config.columns.length">
      <ng-container
        *ngTemplateOutlet="expandedInnerCell; context: { row: innerRow, columns: config.columns }"
      ></ng-container>
    </td>
  </ng-container>

  <!-- Row Defs -->
  <tr mat-header-row *matHeaderRowDef="config.columns; sticky: true"></tr>
  <tr
    mat-row
    [ngClass]="{ pair: index % 2 === 0, 'not-pair': index % 2 !== 0 }"
    (click)="row.click()"
    *matRowDef="let row; let index = index; columns: config.columns"
  ></tr>
  <tr mat-row *matRowDef="let row; columns: ['__rowContent__']" class="MoyTable__expandable-content"></tr>
</table>

<!-- Default Row-->
<ng-template #defaultCell let-row="row" let-column="column">
  <ng-container [ngSwitch]="row.cellMap[column].type">
    <ng-container *ngSwitchCase="InputType.Text">
      <moy-input [config]="row.cellMap[column]"></moy-input>
    </ng-container>

    <ng-container *ngSwitchCase="InputType.Number">
      <moy-input [config]="row.cellMap[column]"></moy-input>
    </ng-container>

    <ng-container *ngSwitchCase="MoyButtonType.Round">
      <moy-button [config]="row.cellMap[column]"></moy-button>
    </ng-container>

    <ng-container *ngSwitchCase="'table_loading'">
      <div class="loading-effect">{{ config.customColumnText[column] ? 'O' : column }}</div>
    </ng-container>
  </ng-container>
</ng-template>

<!-- Expandable Row -->
<ng-template #expandableCell let-row="row" let-column="column">
  <ng-container *ngIf="row.cellMap[column].control">
    <moy-input class="MoyTable__expandable" [config]="row.cellMap[column]"></moy-input>
    <span class="MoyTable__expandable-counter" *ngIf="config.mergeStrategy.pivot === column">
      {{ row.innerRows.length }}
    </span>
  </ng-container>
</ng-template>

<!-- Inner Row -->
<ng-template #expandedInnerCell let-row="row" let-columns="columns">
  <div class="MoyTable__row-content" [@verticalExpandCollapse]="row.expanded ? 'expanded' : 'collapsed'">
    <table mat-table [dataSource]="row.innerRows">
      <ng-container [matColumnDef]="_column" *ngFor="let _column of columns; trackBy: columnFn">
        <td mat-cell *matCellDef="let innerRow">
          <ng-container *ngTemplateOutlet="defaultCell; context: { row: innerRow, column: _column }"></ng-container>
        </td>
      </ng-container>
      <tr mat-row *matRowDef="let innerRow; columns: columns"></tr>
    </table>
  </div>
</ng-template>
